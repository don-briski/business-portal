<section>
  <div class="card-header">
    <div class="d-flex justify-content-between align-items-center">
      <h3 class="m-0">Loan Configuration</h3>
      <button
        *ngIf="
          user.permission.includes('Edit Risk Engine Configuration') &&
          (mode === creditAffordModeEnum.View ||
            mode === creditAffordModeEnum.None)
        "
        class="btn btn-sm px-6 text-white mr-1"
        [style.backgroundColor]="currentTheme?.secondaryColor"
        (click)="
          onModeChange(
            mode === creditAffordModeEnum.None
              ? creditAffordModeEnum.Configure
              : creditAffordModeEnum.Edit
          )
        "
      >
        {{ config ? "Edit" : "Configure" }}
      </button>
    </div>
  </div>
  <div class="card-body">
    <no-data
      *ngIf="mode === creditAffordModeEnum.None"
      title="Not Yet Configured"
      desc="Click on the button above to set the configuration"
    ></no-data>
    <p
      *ngIf="
        mode === creditAffordModeEnum.Configure ||
        mode === creditAffordModeEnum.Edit
      "
    >
      {{ mode === creditAffordModeEnum.Edit ? "Update" : "Set" }} the parameters
      for loan configuration
    </p>
    <div *ngIf="mode !== creditAffordModeEnum.None" id="tips">
      <p
        [style.color]="currentTheme?.secondaryColor"
        class="cursor text-underline"
        (click)="hideHints = !hideHints"
      >
        {{ hideHints ? "Show" : "Hide" }} Hints
      </p>

      <ul *ngIf="!hideHints">
        <li>
          <b>AutoDecline toggle: </b>
          <span class="hint-color"
            >This configuration will allow users to enable or disable automatic
            decline for any loan categories (A, B, C, D, E).</span
          >
        </li>

        <li>
          <b>No Bank Check toggle: </b
          ><span class="hint-color"
            >This configuration will allow users to enable or disable bank check
            for any loan categories (A, B, C, D, E).</span
          >
        </li>

        <li>
          <b>Limit Threshold Amount: </b>
          <span class="hint-color"
            >Define the maximum allowable loan amount across all
            categories.</span
          >
        </li>

        <li>
          <b>Min Income Amount: </b
          ><span class="hint-color"
            >This sets the period in months which is how far back in the bank
            statement should the transaction search be for</span
          >
        </li>

        <li>
          <b>Max Tenor (months): </b
          ><span class="hint-color"
            >Users can set the maximum loan tenor (repayment period) in months
            by category that all loan limits will be generated by.</span
          >
        </li>

        <li>
          <b>Min Loan Amount: </b
          ><span class="hint-color"
            >This configuration will allow users to define the minimum loan
            amount allowed per category.</span
          >
        </li>

        <li>
          <b>Max Loan Amount: </b
          ><span class="hint-color"
            >This configuration will allow users to define the maximum loan
            amount allowed per category.</span
          >
        </li>

        <li>
          <b>Max DTI % (Debt-to-income): </b
          ><span class="hint-color"
            >This configuration will allow users set a maximum allowable
            Debt-to-Income ratio per category.</span
          >
        </li>
        <li>
          <b
            >Installment Multiplier (%) (on the installment inclusive of
            interest): </b
          ><span class="hint-color"
            >This configuration will allow users set a multiplier factor used in
            the determination of a loan application. </span
          >
        </li>

        <li>
          <b>Interest Rate (%): </b
          ><span class="hint-color"
            >Users can set the interest rate for loan calculations per
            category.</span
          >
        </li>

        <li>
          <b>Secondary Routes: </b
          ><span class="hint-color"
            >These are alternative routes that are added on to the main
            Affordability logic to extend the flexibility in calculating
            customer loan limits.</span
          >
        </li>
      </ul>
    </div>
    <form
      *ngIf="
        mode === creditAffordModeEnum.Configure ||
        mode === creditAffordModeEnum.Edit
      "
      [formGroup]="form"
      (ngSubmit)="submit()"
    >
      <div formArrayName="categories">
        <ng-container
          *ngFor="let control of categoriesControls().controls; let i = index"
        >
          <div
            id="accordions"
            class="shadow-lg px-6 py-1 mt-6 rounded"
            [formGroup]="control"
          >
            <lnd-accordion
              [accordionId]="control.value.key"
              [title]="control.value.title"
              [open]="true"
            >
              <div class="d-flex flex-wrap mt-3">
                <div
                  class="d-flex align-items-center my-6"
                  *ngIf="displaySwitches"
                >
                  <lnd-switch
                    [value]="form.value.categories[i].autoDecline"
                    text="Auto Decline"
                    (emittedValue)="toggleSwitch($event, 'autoDecline', i)"
                  ></lnd-switch>

                  <div class="d-flex align-items-center ml-5">
                    <lnd-switch
                      [value]="form.value.categories[i].noBankCheck"
                      text="No Bank Check"
                      (emittedValue)="toggleSwitch($event, 'noBankCheck', i)"
                    ></lnd-switch>
                  </div>
                </div>

                <div class="w-100">
                  <div class="form-row">
                    <div class="col-md-6 mb-3">
                      <label
                        >Limit Threshold Amount
                        <b class="text-danger">*</b></label
                      >

                      <input
                        type="text"
                        class="form-control"
                        placeholder="Enter limit threshold amount"
                        formControlName="limitThresholdAmount"
                        currencyMask
                        [options]="{
                          prefix: currencySymbol,
                          thousands: ',',
                          decimal: '.'
                        }"
                      />

                      <lnd-input-errors
                        label="Limit Threshold Amount"
                        [control]="control.get('limitThresholdAmount')"
                      ></lnd-input-errors>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label
                        >Min Income amount <b class="text-danger">*</b></label
                      >

                      <input
                        type="text"
                        class="form-control"
                        placeholder="Enter min income amount"
                        formControlName="minIncomeAmount"
                        currencyMask
                        [options]="{
                          prefix: currencySymbol,
                          thousands: ',',
                          decimal: '.'
                        }"
                      />
                      <lnd-input-errors
                        label="Min Income Amount"
                        [control]="control.get('minIncomeAmount')"
                      ></lnd-input-errors>
                    </div>

                    <div class="col-md-6 mb-3">
                      <label
                        >Max Tenor (months) <b class="text-danger">*</b></label
                      >
                      <slct-2
                        placeholder="Select Maximum Tenor Period"
                        [data]="maxTenorRange"
                        [customSearchEnabled]="true"
                        formControlName="maxTenor"
                      ></slct-2>
                      <lnd-input-errors
                        label="Max Tenor"
                        [control]="control.get('maxTenor')"
                      ></lnd-input-errors>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label
                        >Min Loan Amount <b class="text-danger">*</b></label
                      >
                      <input
                        type="text"
                        class="form-control"
                        placeholder="Enter limit threshold amount"
                        formControlName="minLoan"
                        currencyMask
                        [options]="{
                          prefix: currencySymbol,
                          thousands: ',',
                          decimal: '.'
                        }"
                      />
                      <lnd-input-errors
                        label="Min Loan"
                        [control]="control.get('minLoan')"
                      ></lnd-input-errors>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label
                        >Max Loan Amount <b class="text-danger">*</b></label
                      >
                      <input
                        type="text"
                        class="form-control"
                        placeholder="Enter max loan amount"
                        formControlName="maxLoan"
                        currencyMask
                        [options]="{
                          prefix: currencySymbol,
                          thousands: ',',
                          decimal: '.'
                        }"
                      />
                      <lnd-input-errors
                        label="Max Loan"
                        [control]="control.get('maxLoan')"
                      ></lnd-input-errors>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label>Max DTI (%)<b class="text-danger">*</b></label>
                      <input
                        type="number"
                        class="form-control"
                        placeholder="Enter max DTI"
                        formControlName="maxDTI"
                      />
                      <lnd-input-errors
                        label="Max DTI"
                        [control]="control.get('maxDTI')"
                      ></lnd-input-errors>
                    </div>
                    <div class="col-md-6">
                      <label
                        >Installment Multiplier
                        <b class="text-danger">*</b></label
                      >
                      <input
                        type="number"
                        class="form-control"
                        placeholder="Set number of days"
                        formControlName="instalmentMultiplier"
                      />
                      <lnd-input-errors
                        label="installment Multiplier"
                        [control]="control.get('instalmentMultiplier')"
                      ></lnd-input-errors>
                    </div>
                    <div class="col-md-6">
                      <label
                        >Interest Rate (%) <b class="text-danger">*</b></label
                      >
                      <input
                        type="number"
                        class="form-control"
                        placeholder="Enter interest rate"
                        formControlName="interestRate"
                      />
                      <lnd-input-errors
                        label="Interest Rate"
                        [control]="control.get('interestRate')"
                      ></lnd-input-errors>
                    </div>
                  </div>
                  <div class="col-12 mb-5 pl-0">

                    <!-- Do not delete -->
                    <!-- <div class="d-flex align-items-center">
                      <lnd-switch
                        [value]="control.value.autoDeclineByEarningClassIsTrue"
                        text="Set Auto Decline Earning Classes"
                        (emittedValue)="toggleSwitch($event, 'earningClass', i)"
                      ></lnd-switch>
  
                      <div class="ml-5 w-25" *ngIf="control.value.autoDeclineByEarningClassIsTrue">
                        <slct-2
                        [data]="earningClassArr"
                        placeholder="Select Earning Classes"
                        formControlName="earningClassesToDecline"
                        [customSearchEnabled]="false"
                        [multiple]="true"
                      ></slct-2>
                        <lnd-input-errors
                          label="Auto decline earning classes"
                          [control]="control.get('autoDeclineByEarningClassCategories')"
                        />
                      </div>
                    </div> -->

                    <div class="d-flex align-items-center mr-5">
                      <lnd-switch
                        [value]="control.value.useSecondaryRoute"
                        text="Secondary Route"
                        (emittedValue)="
                          toggleSwitch($event, 'useSecondaryRoute', i)
                        "
                      ></lnd-switch>
                    </div>
                    <small class="text-danger"
                      >When toggled on, the system will enable an alternate
                      route for calculating the customer's affordability</small
                    >

                    <div
                      class="w-50 mt-3"
                      *ngIf="control.value.useSecondaryRoute"
                    >
                      <slct-2
                        [data]="secondaryRoutes"
                        placeholder="Select Route"
                        formControlName="route"
                      ></slct-2>
                    </div>
                  </div>

                  <div class="form-row" *ngIf="i === 0 && control.valid">
                    <div class="col-12">
                      <div class="d-flex align-items-center mr-5">
                        <lnd-switch
                          [value]="useSameSettings"
                          text="Toggle to use the same settings for other categories"
                          (emittedValue)="
                            toggleSwitch($event, 'useSameSettings')
                          "
                        ></lnd-switch>
                      </div>
                      <small class="text-danger"
                        >When toggled on, the system will automatically apply
                        the settings from one category to update all other
                        categories. You can also edit each category individually
                        if necessary.</small
                      >
                    </div>
                  </div>
                </div>
              </div>
            </lnd-accordion>
          </div>
        </ng-container>
      </div>
      <button
        class="btn btn-danger mt-6 mr-3"
        [disabled]="isLoading"
        (click)="onModeChange(creditAffordModeEnum.View)"
      >
        Cancel
      </button>
      <button
        class="btn mt-6"
        [disabled]="!form.valid || isLoading"
        type="submit"
        [style.backgroundColor]="currentTheme?.secondaryColor"
      >
        {{ isLoading ? "Processing..." : "Update" }}
        <i *ngIf="isLoading" class="icon icon-spin2 icon-spin"></i>
      </button>
    </form>
    <ng-container *ngIf="mode === creditAffordModeEnum.View">
      <lnd-accordion
        accordionId="catA"
        accordionClass="accordion-border"
        title="Category A"
        [open]="true"
      >
        <div class="d-flex flex-wrap">
          <div
            *ngFor="let item of accordionItems?.categoryA"
            class="accordion-item-wrapper"
          >
            <lnd-accordion-item
              [bgColor]="
                getLightenedColor(currentTheme?.primaryColor, lightenAmount)
              "
              [primaryColor]="currentTheme?.primaryColor"
              [title]="item?.title"
              [useTitleCasePipe]="false"
              [value]="item?.value"
              [type]="item?.type"
              [tooltip]="item?.tooltip"
            ></lnd-accordion-item>
          </div>
        </div>
      </lnd-accordion>
      <lnd-accordion
        accordionId="catB"
        accordionClass="accordion-border"
        title="Category B"
        [open]="true"
      >
        <div class="d-flex flex-wrap">
          <div
            *ngFor="let item of accordionItems?.categoryB"
            class="accordion-item-wrapper"
          >
            <lnd-accordion-item
              [bgColor]="
                getLightenedColor(currentTheme?.primaryColor, lightenAmount)
              "
              [primaryColor]="currentTheme?.primaryColor"
              [title]="item?.title"
              [useTitleCasePipe]="false"
              [value]="item?.value"
              [type]="item?.type"
              [tooltip]="item?.tooltip"
            ></lnd-accordion-item>
          </div>
        </div>
      </lnd-accordion>
      <lnd-accordion
        accordionId="catC"
        accordionClass="accordion-border"
        title="Category C"
        [open]="true"
      >
        <div class="d-flex flex-wrap">
          <div
            *ngFor="let item of accordionItems?.categoryC"
            class="accordion-item-wrapper"
          >
            <lnd-accordion-item
              [bgColor]="
                getLightenedColor(currentTheme?.primaryColor, lightenAmount)
              "
              [primaryColor]="currentTheme?.primaryColor"
              [title]="item?.title"
              [useTitleCasePipe]="false"
              [value]="item?.value"
              [type]="item?.type"
              [tooltip]="item?.tooltip"
            ></lnd-accordion-item>
          </div>
        </div>
      </lnd-accordion>
      <lnd-accordion
        accordionId="catD"
        accordionClass="accordion-border"
        title="Category D"
        [open]="true"
      >
        <div class="d-flex flex-wrap">
          <div
            *ngFor="let item of accordionItems?.categoryD"
            class="accordion-item-wrapper"
          >
            <lnd-accordion-item
              [bgColor]="
                getLightenedColor(currentTheme?.primaryColor, lightenAmount)
              "
              [primaryColor]="currentTheme?.primaryColor"
              [title]="item?.title"
              [useTitleCasePipe]="false"
              [value]="item?.value"
              [type]="item?.type"
              [tooltip]="item?.tooltip"
            ></lnd-accordion-item>
          </div>
        </div>
      </lnd-accordion>
      <lnd-accordion
        accordionId="catE"
        accordionClass="accordion-border"
        title="Category E"
        [open]="true"
      >
        <div class="d-flex flex-wrap">
          <div
            *ngFor="let item of accordionItems?.categoryE"
            class="accordion-item-wrapper"
          >
            <lnd-accordion-item
              [bgColor]="
                getLightenedColor(currentTheme?.primaryColor, lightenAmount)
              "
              [primaryColor]="currentTheme?.primaryColor"
              [title]="item?.title"
              [useTitleCasePipe]="false"
              [value]="item?.value"
              [type]="item?.type"
              [tooltip]="item?.tooltip"
            ></lnd-accordion-item>
          </div>
        </div>
      </lnd-accordion>
    </ng-container>
  </div>
</section>
